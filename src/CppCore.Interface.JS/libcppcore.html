<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World - AssemblyScript</title>
    <!--<script type="module" src="test2.mjs"></script>-->
  </head>
  <style>
    h1 {
      text-align: center;
      margin: auto;
      width: 512px;
    }

    textarea {
      width: 512px;
      height: 128px;
      resize: vertical;
      box-sizing: border-box
    }
    button {

      height: 32px;
    }

    #menu {
      margin: auto;
      width: 512px;
    }
    .menu_entry {
      margin: auto;
      width: 128px;
    }
    #content {
      margin: auto;
      width: 512px;
    }
 
    .container {
      width: 100%; 
      display: flex; 
      justify-content: center; 
      align-items: center;
    }
    .containerItem {
      float: left; 
      display: flex; 
      justify-content: center; 
      align-items: center;
    }
  </style>
  <body>
    <h1>libcppcore</h1>
    <div id="menu">
      <a class=menu_entry" id="menu_basex">BaseX</a>
      <a class=menu_entry" id="menu_primes">Primes</a>
    </div>

    <div id="content" />

    <script type="module">
      import { 
        Buffer,
        CString,
        BaseX,
        Base10,
        BASE02,
        BASE10,
        BASE16,
        UInt,
        UInt32,
        UInt64,
        UInt128,
        UInt256,
        UInt1024,
        UInt2048,
        UInt4096,
        UInt8192,
        AES128ECB,
        AES128CBC,
        PBKDF2,
        MD5, SHA256, SHA512, CRC32, CRC32C,
        Prime
      } from './libcppcore.js'
      

      function getRandomInt(max) {
          return Math.floor(Math.random() * max);
      }


      function testBuffer() {
          const a = [0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08];
          const b = new Buffer(a);
          console.log(a);
          console.log(b);
      }

      function testCString() {
        var s = new CString("hello");
        console.log(s);
        /*console.log(s.toString());
        console.log(s.byteLength);
        console.log(s.maxLength);
        console.log(s._ptr);*/


        /*var s2 = s.slice(0, 1);
        console.log(s2);
        console.log(s2.byteLength);*/

        var s3 = new CString(s);
        //console.log(s3.toString());
        console.log(s3.byteLength);
        console.log(s3.maxLength);

        //var s4 = s.subarray(0, 1);
        //console.log(s4);
      }

      function testBaseX() {
        
        /*var s = new CString(31);
        console.log("LEN: " + s.byteLength);
        console.log("decoding...");
        var str1 = new CString("hello world");
        console.log(str1.toString());
        console.log("----------");
        str1.fromString("blabla");
        console.log(str1.toString());*/
             
        /*console.log("32B,B10:" + BaseX.estimateSymbols(32, 10));
        console.log("32B,B02:" + BaseX.estimateSymbols(32,  2));
        console.log("32B,B16:" + BaseX.estimateSymbols(32, 16));

        console.log("32B,B10:" + BaseX.estimateBits(11, 10));
        console.log("32B,B02:" + BaseX.estimateBits(32,  2));
        console.log("32B,B16:" + BaseX.estimateBits(8, 16));*/

        //

        /*var basex = new BaseX("0123456789");
        var dec = basex.decode("1024");
        console.log(dec);
        var enc = basex.encode(dec);
        console.log(enc);*/

        var basex = new BaseX("0123456789ABCDEF");
        var dec = basex.decode("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");
        console.log(dec);
        var enc = basex.encode(dec);
        console.log(enc);


        //console.log(dec._ptr);

        //var v = basex.decode128("9999999999999999999999999999999999999999999999999");
        //console.log(v);

      }

      function testUInt() {
        const iter = 1000;
        let bigs1 = [];
        let bigs2 = [];
        let ints1 = [];
        let ints2 = [];
        for (var i = 0; i < iter; i++) {
            const rnd1 = getRandomHexStr(2048);
            const rnd2 = getRandomHexStr(2048);
            bigs1.push(BigInt(rnd1));
            bigs2.push(BigInt(rnd2));
            ints1.push(new UInt8192(rnd1));
            ints2.push(new UInt8192(rnd2));
        }
        let start = null;
        let end = null;
        let r = BigInt(0);
        let b1 = new UInt8192("0");
        let b2 = new UInt8192("0");
        let t  = new UInt8192("0");

        start = Date.now();
        for (var i = 0; i < iter; i++) {
          r += bigs1[i] * bigs2[i];
          r = BigInt.asUintN(8192, r);
        }
        end = Date.now();
        console.log(r);
        console.log("Duration BigInt: " + (end-start));

        start = Date.now();
        for (var i = 0; i < iter; i++) {
          //UInt128.divmod(ints1[i], ints2[i], b1, t);
          UInt8192.mul(ints1[i], ints2[i], b1);
          UInt8192.add(b1, b2, b2);
        }
        end = Date.now();
        console.log(b2.toString());
        console.log("Duration UInt: " + (end-start));
      }

      function testAES() {
        console.log("TESTING AES");

        var x = 8192*64;
        console.log(x & 0x0F);
        console.log(x >> 4);

        var aes1 = new AES128CBC();
        //var aes2 = new AES128CBC();
        //var key = new AES.Key();
        //key.setUint32(0, 4294967295);

        //aes.reset(new Buffer(16));
        //aes.reset("0123456789ABCDEF");
        //aes.reset(new CString("0123456789ABCDEF"));
        //aes1.setKey("0123456789ABCDEF");
        aes1.setKey(new Uint8Array(16));
        aes1.setIV("0123456789ABCDEF");
        //aes1.setIV("0123456789ABCDEF");
        //aes2.setKey(new Uint8Array(16), new Buffer(16));

        //console.log(aes1._iv_enc);
        //console.log(aes1._iv_dec);
        
        //var data_in = new Buffer(32);
        var data_in = new CString("0123456789abcdef");
        var data_out = new Buffer(64);
        var data_str = new CString(32);
        console.log(data_in.toString());

        aes1.encrypt(data_in, data_out);
        //console.log(aes1._iv_enc);
        //console.log(aes1._iv_dec);
        console.log(data_out.toString());

        aes1.decrypt(data_out.subarray(0, 16), data_str);
        console.log(data_str.toString());

        /*data_out.setUint32(0, 0);
        data_out.setUint32(4, 0);
        data_out.setUint32(8, 0);
        data_out.setUint32(12, 0);
        
        data_in.setUint32(0, 4294967295);
        data_in.setUint32(4, 4294967295);
        data_in.setUint32(8, 4294967295);
        data_in.setUint32(12, 4294967295);

        console.log("Before:")
        console.log(data_out.getUint32(0));
        aes.encrypt(data_in, data_out, 1);
        console.log("After:")
        console.log(data_out.getUint32(0));

        data_in.setUint32(0, 0);
        data_in.setUint32(4, 0);
        data_in.setUint32(8, 0);
        data_in.setUint32(12, 0);

        console.log("Before:")
        console.log(data_in.getUint32(0));
        aes.decrypt(data_out, data_in, 1);
        console.log("After:")
        console.log(data_in.getUint32(0));*/
      }
      
      function testPrime() {
        /*var t1 = Date.now();
        var p = new UInt128();
        Prime.generate(p, false, 0);
        var t2 = Date.now();
        console.log("gen took:" + (t2-t1));
        var p2 = UInt128.fromString("0b11");
        console.log(p2.toString());*/

        var p = new UInt4096("0x0397ffffffffffffffffffffffffffff");
        var r = Prime.test(p, Prime.Certainty.Max);
        console.log(r);

        //r = Prime.test(33333333333333333333, false, 0);
        //console.log(r);
      }
      
      function testPBKDF2() {
          //var digest = new Buffer(32);
          //var digest = new UInt256();
          var digest = new Uint8Array(32);
          PBKDF2.sha256(
            "test1",
            new Uint8Array([0xFF, 0xFE]),
            digest,
            10000
          );
          console.log(digest);
      }

      function testHash() {
        var h = new CRC32C();
        //var b = new UInt128();
        var b = new Uint8Array(CRC32C.digestLength);

        h.reset();
        h.step(new Uint8Array([0xFF, 0xFF, 0xEF]));
        h.finish(b);
        console.log(b.toString(16));
      }
      
      //testBuffer();
      //testCString();
      //testBaseX();
      //testUInt();
      //testAES();
      //testPBKDF2();
      testHash();
      //testPrime();








      document.getElementById("menu_basex").onclick = function () { 
        //testPrime(); 
      };
      
      document.getElementById("menu_primes").onclick = function () {
        const headertest = document.createElement("h2");
        headertest.innerText = "Test";
        const containertest = document.createElement("div");
        containertest.className = "container";
        const containertestleft = document.createElement("div");
        containertestleft.className = "containerItem"
        containertestleft.style = "width: 50%";
        const containertestright = document.createElement("div");
        containertestright.className = "containerItem"
        containertestright.style = "width: 50%";
        const labelcertainty = document.createElement("label");
        labelcertainty.innerText = "Certainty: ";
        labelcertainty.style = "padding-right: 8px"
        const certainty = document.createElement("input");
        certainty.type = "number";
        certainty.value = Prime.Certainty.Default;
        certainty.style = "width: 100%"
        const labelresult = document.createElement("label");
        labelresult.innerText = "[RESULT]";
        containertestleft.append(labelcertainty, certainty);
        containertestright.append(labelresult);
        containertest.append(containertestleft, containertestright);
        const textareatest = document.createElement("textarea");
        textareatest.placeholder = "Enter decimal number or hex prefixed with 0x";
        const buttontest = document.createElement("button");
        buttontest.innerText = "Test";
        buttontest.style = "width: 100%"
        buttontest.onclick = function () { 
          const v = textareatest.value;
          try {
            const r = Prime.test(UInt.fromString(v), certainty.value);
            if (r == Prime.Result.NotPrime) {
              labelresult.innerText = "NOT PRIME";
            }
            else if (r == Prime.Result.Prime) {
              labelresult.innerText = "PRIME";
            }
            else if (r == Prime.Result.LikelyPrime) {
              labelresult.innerText = "LIKELY PRIME";
            }
          }
          catch (e) {
            labelresult.innerText = e.message;
          }
        }

        const headergenerate = document.createElement("h2");
        headergenerate.innerText = "Generate";
    
        const bits = document.createElement("select");
        const option = document.createElement ("option");
        option.value = 1024;
        option.text = "1024";
        bits.append(option);

        //const buttonGenerate = document.createElement("button")
        //buttonGenerate.innerText = "Generate";
        //buttonGenerate.style = "width: 50%"

        //buttons.append(buttonTest);

        document.getElementById("content").replaceChildren(
          headertest, containertest, textareatest, buttontest,
          headergenerate);
      };

      document.getElementById("menu_primes").click();
      
    </script>

  </body>
</html>
